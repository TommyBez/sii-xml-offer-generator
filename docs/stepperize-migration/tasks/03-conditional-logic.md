# Task 03 – Conditional Logic Migration

**Parent checklist item:** `#3 Conditional Logic`

Legacy conditional flows live in two places:
1. `lib/wizard-config.ts` – `isVisible` & `dependsOn` callbacks.  
2. `store/wizard-store.ts` – helper methods `isStepVisible`, `canNavigateToStepId`, etc.

Goal: **delete those implementations** and rebuild the logic using Stepperize's APIs (`switch`, `when`, `metadata`, custom guards).  This task ensures that hidden/optional steps appear or disappear at runtime exactly as before.

---

## 0. Scope
* `lib/step-conditions.ts` (new file) – pure functions.  
* Any form components whose visibility depends on input.  
* Navigation bar & controls (must respect accessibility rules).  

---

## 1. Objectives
1. **Mapping** – replicate every `isVisible` rule from old config as a named function in `step-conditions.ts`.
2. **Execution sites** – call these functions in:
   * `Stepper.switch({...})` for **rendering**.
   * Navigation buttons to compute `isDisabled`.
3. **Dependency logic** (`dependsOn`) – enforced via `stepper.metadata.completed` checks, preventing forward navigation until prerequisites are complete.
4. Remove duplicate logic from store.

---

## 2. Branch & PR conventions
| Item | Value |
|------|-------|
| Branch name | `feat/migration-task-03-conditional-logic` |
| PR title | `Task 03 – Port conditional visibility to Stepperize` |
| Depends on | Task-02 merged |
| Labels | `migration`, `conditional`, `stepperize`, `task-03` |

---

## 3. Implementation Steps

### 3.1 Create `lib/step-conditions.ts`
```ts
import { FormData } from '@/types'; // global aggregate type
import { StepId } from '@/lib/stepper';

export const isOfferCharacteristicsVisible = (data: FormData): boolean => {
  const { TIPO_OFFERTA, TIPO_MERCATO } = data.offerDetails ?? {} as any;
  return TIPO_OFFERTA === '03' || TIPO_MERCATO === '01';
};

export const isEnergyPriceReferencesVisible = (data: FormData): boolean => {
  if (data.offerDetails?.TIPO_OFFERTA !== '02') return false;
  const discounts = data.discounts ?? [];
  return !discounts.some((d) => d.TIPOLOGIA === '04');
};

// … replicate all other conditions …

export const stepVisibleMap: Record<StepId, (d: FormData) => boolean> = {
  'offer-characteristics': isOfferCharacteristicsVisible,
  'energy-price-references': isEnergyPriceReferencesVisible,
  // …
};
```

### 3.2 Consume in `WizardLayout`
```tsx
const visibleSteps = stepper.all.filter((s) =>
  stepVisibleMap[s.id]?.(store.formData) ?? true
);

return stepper.switch(
  Object.fromEntries(
    visibleSteps.map((s) => [s.id, () => <PanelLoader id={s.id} />])
  )
);
```

### 3.3 Disable navigation if prerequisites incomplete
```tsx
const isAccessible = (id: StepId) => {
  const prereqs = dependsOnMap[id] ?? [];
  return prereqs.every((p) => stepper.metadata[p]?.completed);
};
```
The `dependsOnMap` can be generated by copying from old file or hard-coding.

### 3.4 Validation hook for dynamic updates
Whenever form data changes, call `calculateVisibleSteps()` in a `useEffect` to re-render navigation.  Stepperize panels not in DOM are automatically unmounted.

### 3.5 Remove legacy helpers
Delete:
* `isStepVisible`, `isStepAccessible`, `canNavigateToStepId` from `wizard-store.ts`.
* `getVisibleSteps()` from `wizard-config.ts` (remove file entirely when Task-04 done).

---

## 4. Tests
1. **Unit**: Import `stepVisibleMap` and provide mock `FormData` scenarios. Verify boolean outcome.
2. **E2E**: Playwright script fills inputs to toggle a step (e.g., selects variable offer → Energy Price References step appears).

---

## 5. Risks & Mitigation
| Risk | Mitigation |
|------|------------|
| Infinite render loop if `calculateVisibleSteps` updates state each render | Memoize with `useMemo` + dependency array |
| Navigation dead-end if dependsOn mis-typed | Unit tests with permutations |

---

## 6. Effort Estimate
* Port rules – **2 h**
* Integration & compile – **1 h**
* Tests – **1 h**
* Review – **1 h**

_Total: ~5 developer hours._

---

## 7. Definition of Done
- [ ] All conditions ported and unit-tested.
- [ ] Navigation bar hides inaccessible steps.
- [ ] Forward navigation blocked until dependencies completed.
- [ ] Legacy visibility helpers removed.
- [ ] CI green.

---

**➡ Continue to:** Task-04 (Navigation UI Cleanup) 